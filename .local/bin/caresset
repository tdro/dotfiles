#!/bin/sh -eu

program=$(basename "$0")
identifier=ok4out6I
image="/tmp/$program-$identifier.png"

Help() {
printf \
"
Usage: %s [FLAGS]... [ARGUMENT]...

The program $program shall use OCR (Optical Character Recognition) to retrieve
text from the selected part of the screen.

  Command List:

   $program select              Select text on screen.
   $program select qr           Select quick response code on screen.
   $program check               Checks dependencies.
   $program help                Show this help menu.

   %${#program}s -h -help --help     Other help menu flags.

" "$program";
}

Check() {
  escrotum    --version
  notify-send --version
  tesseract   --version
  xsel        --version
  zbarimg     --version
  magick      --version
  rm          --version
}

Scan() {
  escrotum -s "$image" > /dev/null
  magick "$image" -normalize -sharpen 10x1000 -colorspace Gray -gamma 3 -level 25%,100% "$image"
  trap 'rm "$image" > /dev/null 2>&1 || true; trap - EXIT; exit' EXIT INT HUP
  text=$(tesseract "$image" -)
  [ -z "$text" ] && notify-send "Selection is empty" && exit
  notify-send "$text"
  printf "%s" "$text" | xsel -ib
}

QR() {
  escrotum -s "$image" > /dev/null
  trap 'rm "$image" > /dev/null 2>&1 || true; trap - EXIT; exit' EXIT INT HUP
  text=$(zbarimg --raw --quiet "$image")
  [ -z "$text" ] && notify-send "QR selection is empty" && exit
  notify-send "$text"
  printf "%s" "$text" | xsel -ib
}

{ [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ] || [ "$#" = 0 ]; } && Help && exit;

[ "${1:-}" = "select" ] && [ "${2:-}" = "qr" ] && QR && exit;

[ "${1:-}" = "select" ] && [ "${2:-}" = "" ] && Scan && exit;

[ "${1:-}" = "check" ] && Check && exit;

[ "${1:-}" = "help" ] && Help && exit;

Help && printf "Error: Unknown argument: " && printf "'%s' " "$@" && printf "\n" && exit 1
