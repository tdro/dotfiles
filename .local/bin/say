#!/bin/sh -eu

program=$(basename "$0")
voices=$HOME/.local/share/piper/voices
message=${*:-Nothing to say.}

Help() {
printf \
"
Usage: %s [FLAGS]... [ARGUMENT]...

The program $program shall use TTS (Text to Speech)
to convert a given text input into speech.

Voices: $voices

  Command List:

   printf 'text' | $program -     # Read piped text.
   $program - < ~/.bashrc         # Read contents of file.

   $program given text            # Say given text.
   $program 'given text'
   $program \"given text\"

   $program echo given text       # With echo effect.
   $program echo 'given text'
   $program echo \"given text\"

   $program check                 # Checks dependencies.
   $program download              # Download default voice.
   $program help                  # Show this help menu.

   %${#program}s -h -help --help       # Other help flags.

" "$program";
}

Check() {
  ffmpeg -version
  wget   -version
  piper  --version
  mkdir  --version
  rm     --version
  sox    --version
  aplay  --version
}

Say() {
  Piper | aplay -f S16_LE -r24000
}

Echo() {
  Piper "${1:-$message}" \
    | sox -t raw -r 22000 -e signed -b 16 - -t raw - echo 0.8 0.85 100 0.4 \
    | aplay -f S16_LE -r24000 && exit
}

Piper() {
 [ ! -s "$voices/en_GB-jenny_dioco-medium.onnx" ] && Download
 [ ! -s "$voices/en_GB-jenny_dioco-medium.onnx" ] && printf "ERROR: Unable to download model\n" && exit 1
  printf '%s' "${1:-$message}" |
    piper \
      --model "$voices/en_GB-jenny_dioco-medium.onnx" \
      --output_raw \
      --noise_w 0.8 \
      --length_scale 1 \
      --sentence_silence 0.2
}

Wget() {
  wget --progress=bar --quiet --show-progress --directory-prefix "$voices" "$@"
}

Download() {
  mkdir --parents "$voices"
  [ -s "$voices/en_GB-jenny_dioco-medium.onnx.json" ] || Wget "https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_GB/jenny_dioco/medium/en_GB-jenny_dioco-medium.onnx.json?download=true.json" \
    -O "$voices/en_GB-jenny_dioco-medium.onnx.json"
  [ -s "$voices/en_GB-jenny_dioco-medium.onnx" ]      || Wget "https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_GB/jenny_dioco/medium/en_GB-jenny_dioco-medium.onnx?download=true" \
    -O "$voices/en_GB-jenny_dioco-medium.onnx"
}

{ [ "${1:-}" = "-h" ] || [ "${1:-}" = "-help" ] || [ "${1:-}" = "--help" ] || [ "$#" = 0 ]; } && Help && Say && exit

[ "${1:-}" = "-" ] && message=$(cat -) Say && exit

[ "${1:-}" = "help" ] && [ "$#" = 1 ] && Help && Say && exit

[ "${1:-}" = "check" ] && [ "$#" = 1 ] && Check && exit

[ "${1:-}" = "download" ] && [ "$#" = 1 ] && Download && exit

[ "${1-}" = "echo" ] && [ "${2-}" = "-" ] && shift 2 && message=$(cat -) Echo && exit;

[ "${1-}" = "echo" ] && shift 1 && Echo "$*" && exit;

Say
